# Phase 10: Customer Onboarding

This phase combines customer onboarding with multi-environment support into a single module that provisions complete customer infrastructure with one Terraform command.

## What This Phase Creates

For each customer in the list, Terraform provisions:

**Azure Resources:**

- Storage container for CNPG database backups
- Key Vault secrets (database credentials, SAS token, Telegram credentials)

**GitOps Manifests** (written to mercury-gitops repo):

- Namespace with Pod Security Standards (restricted)
- SecretProviderClass for Azure Key Vault CSI
- ConfigMap for n8n configuration
- CNPG database cluster with backup configuration
- Barman ObjectStore for Azure Blob backups
- ScheduledBackup for daily backups
- n8n Deployment (PSS-compliant with probes and resource limits)
- Service, Ingress, NetworkPolicy
- Kustomization files

## Quick Start

```bash
# Staging environment
cd staging/
terraform init
terraform apply

# Production environment
cd production/
terraform init
terraform apply
```

## Adding a New Customer

Simply add a name to the customers list in `staging/customers.tf` or `production/customers.tf`:

```hcl
locals {
  customers = toset([
    "julius",
    "cicero",
    # "crassus",   # Uncomment to add
  ])
}
```

Then run `terraform apply` - Terraform generates all manifests automatically.

## Flux Kustomization Dependencies

The Flux configuration uses a specific dependency chain to ensure resources are created in the correct order:

```
infra-controllers     (Traefik, cert-manager, CNPG operator)
        |
        v
  infra-configs       (ClusterIssuers, etc.)
        |
        v
   cnpg-plugin        (Barman cloud plugin - needs cert-manager)
        |
        v
      apps            (Customer workloads - need CNPG plugin)
```

This ordering is critical when deploying from scratch:

1. **cert-manager** must be ready before CNPG plugin (plugin has webhook certificates)
2. **CNPG plugin** must be ready before apps (databases use the barman-cloud plugin)

The dependency is configured in the Terraform Flux configuration:

```hcl
kustomizations {
  name       = "cnpg-plugin"
  path       = "./infrastructure/cnpg-plugin/staging"
  depends_on = ["infra-configs"]
}

kustomizations {
  name       = "apps"
  path       = "./apps/staging"
  depends_on = ["cnpg-plugin"]
}
```

## Telegram Credentials (Demo)

Terraform creates **dummy Telegram credentials** in Key Vault for each customer:

- `{customer}-telegram-bot-token`: Set to `DEMO:dummy-bot-token-replace-me`
- `{customer}-telegram-chat-id`: Set to `000000000`

These allow the infrastructure to deploy without real credentials.

### Using Real Telegram Credentials

To use real Telegram credentials:

1. **Option A: Update via Azure Portal/CLI** (recommended)

   ```bash
   # Update the secret values directly in Key Vault
   az keyvault secret set --vault-name kv-mercury-staging \
     --name julius-telegram-bot-token \
     --value "YOUR_REAL_BOT_TOKEN"

   az keyvault secret set --vault-name kv-mercury-staging \
     --name julius-telegram-chat-id \
     --value "YOUR_REAL_CHAT_ID"
   ```

   The `lifecycle { ignore_changes = [value] }` block prevents Terraform from overwriting your real credentials on subsequent applies.

2. **Option B: Remove from Terraform**

   Comment out the Telegram resources in `modules/customer-onboarding/secrets.tf`:

   ```hcl
   # resource "azurerm_key_vault_secret" "telegram_bot_token" { ... }
   # resource "azurerm_key_vault_secret" "telegram_chat_id" { ... }
   ```

   Then create the secrets manually before deploying apps.

## AKS Identity for GitOps SecretProviderClasses

When creating a new AKS cluster, you must update the identity ID in the GitOps repository's SecretProviderClass configurations.

**After running `terraform apply`, check the output:**

```
gitops_identity_reminder = <<EOT
IMPORTANT: Update the AKS identity in GitOps SecretProviderClasses!

If you recreated the AKS cluster, update this identity ID in:
- monitoring/controllers/staging/kube-prometheus-stack/kustomization.yaml

Current AKS identity: 0790a248-1ece-4f6e-972b-53f8d6cbc108
EOT
```

**Update the identity in GitOps:**

```yaml
# monitoring/controllers/staging/kube-prometheus-stack/kustomization.yaml
patches:
  - target:
      kind: SecretProviderClass
      name: grafana-secrets
    patch: |-
      - op: replace
        path: /spec/parameters/userAssignedIdentityID
        value: "YOUR_NEW_AKS_IDENTITY_HERE"  # <-- Update this!
```

The customer SecretProviderClasses are auto-generated by Terraform with the correct identity, but the monitoring stack's Grafana SecretProviderClass must be updated manually in the gitops repo.

## Quota Requirements

You may need to increase your vCPU quota for your subscription:

<https://learn.microsoft.com/en-us/azure/quotas/quickstart-increase-quota-portal>
